function Filemanager(a){this.fs=null,this.isOK=!1,this.lastSavedtoSync={};var b=this;db.open({server:"CalmlyWriter",version:1,schema:{files:{key:{keyPath:"id",autoIncrement:!0},indexes:{name:{unique:!0}}}}}).then(function(c){dblocalfiles=c,b.isOK=!0,a&&a.call(b)})}function clic_on_grape(){var a=by("id:file_list"),b=this._calmly_id_doc,c=this._calmly_nom_doc,d=this;filemanager.readFile(c+b+".cml",function(e){a.by("class:current_selected_file").removeClass("current_selected_file"),a.by("class:current_opened_file").removeClass("current_opened_file"),d.addClass("current_selected_file");var f=new DOMParser,g=f.parseFromString(e,"text/html"),h=g.getElementsByTagName("body").item(0);for(documenttitle=c,documentid=b,documentDriveId="",entry_persistent=null,editor.mainarea.clear(),editor.mainarea.opacity(0);h.hasChildNodes();)editor.mainarea.seed.appendChild(h.removeChild(h.firstChild));editor.mainarea.animate(200).opacity(1),editor.restoreSelection(),editor.saveSelection(),updatewordcounter(),editor.removeStyles(),editor.removeNBSP(),wrapper.scrollTop(26),resize_window(!1),editor.documentsaved=!0,editor.documentcloudsaved=!0,deleteandinitautosave(),make_links_openable(),by("id:documentremoved_msg").hide(),by("id:no_remove_button").hide(),by("id:yes_remove_button").hide(),by("id:remove_button").show(),by("id:remove_button").removeEvent(),by("id:remove_button").removeClass("remove_button_disabled").clic(function(){this.hide(),by("id:documentremoved_msg").opacity(0).show().style("bottom","8px").animate(200).ease("in").opacity(1).style("bottom","18px"),by("id:yes_remove_button").opacity(0).show().style("bottom","3px").animate(200).ease("in").opacity(1).style("bottom","13px"),by("id:yes_remove_button").removeEvent().clic(function(){removeFileItem(d)}),by("id:no_remove_button").opacity(0).show().style("bottom","3px").animate(200).ease("in").opacity(1).style("bottom","13px"),by("id:no_remove_button").removeEvent().clic(function(){by("id:remove_button").show(),by("id:documentremoved_msg").hide(),by("id:no_remove_button").hide(),by("id:yes_remove_button").hide()})})})}function formatSizeUnits(a){return a>=1e9?a=(a/1e9).toFixed(1)+" GB":a>=1e6?a=(a/1e6).toFixed(1)+" MB":a>=1e3?a=(a/1e3).toFixed(0)+" KB":a>1?a+=" bytes":1==a?a+=" byte":a="0 byte",a}function byteLength(a){for(var b=a.length,c=a.length-1;c>=0;c--){var d=a.charCodeAt(c);d>127&&d<=2047?b++:d>2047&&d<=65535&&(b+=2),d>=56320&&d<=57343&&c--}return b}Filemanager.fn=Filemanager.prototype,Filemanager.fn.getFiles=function(a){if(0==this.isOK)return!1;var b=this;dblocalfiles.files.query().all().execute().then(function(c){a.call(b,c)})},Filemanager.fn.generateGrape=function(a,b,c,d,e){var f=new Grape("a","html").addClass("file_item");f._calmly_id_doc=a.substr(a.length-40,36),f._calmly_nom_doc=a.substr(0,a.length-40),documentid==f._calmly_id_doc&&documenttitle==f._calmly_nom_doc&&f.addClass("current_opened_file");var g=f._calmly_nom_doc.trim();return""==g&&(g="..."),e&&(g=e),f.addChild(new Grape("div","html").addClass("file_title").text(g)),f.addChild(new Grape("div","html").addClass("file_date").text(moment(b).calendar())),f.addChild(new Grape("div","html").addClass("file_bytes").text(formatSizeUnits(c))),f.clic(function(){var a=this;this.containsClass("current_selected_file")?wrapper.clic():clic_on_grape.call(a)}),f},Filemanager.fn.getGrapes=function(){var a=this;this.getFiles(function(b){by("id:file_list").clear(),b.sort(function(a,b){return a.date<b.date?1:a.date>b.date?-1:0}),by("id:remove_button").removeEvent(),by("id:remove_button").addClass("remove_button_disabled");for(var c=0;c<b.length;c++){var d="";if("untitled"==b[c].name.substr(0,b[c].name.length-40)){var e=new DOMParser,f=e.parseFromString(b[c].content,"text/html"),g=f.getElementsByTagName("body").item(0);g=new Grape(g,"html").text().trim(),g=g.replace(/\s+/g," "),g.length>100&&(g=g.substr(0,100)+"..."),g.length&&(d=g)}var h=a.generateGrape(b[c].name,b[c].date,b[c].size,b[c].fullpath,d);by("id:file_list").addChild(h)}})},Filemanager.fn.addFile=function(a,b,c,d){"boolean"!=typeof d&&(d=!1);var e=this;return 0!=this.isOK&&(b=b,void dblocalfiles.files.query("name").only(a).execute().then(function(f){var g=(new Date).getTime(),h=byteLength(b);if(f.length>0){var i=!0;d&&(i=!1),dblocalfiles.files.query("name").only(a).modify({content:b,date:g,changed:i,size:h,fullpath:""}).execute().then(function(){c&&c.call(),e.addGrape(a,g,h)})}else d?dblocalfiles.files.add({name:a,content:b,date:g,changed:!1,size:h,fullpath:""}).then(function(){c&&c.call(),e.addGrape(a,g,h)}):dblocalfiles.files.add({name:a,content:b,date:g,changed:!0,size:h,fullpath:""}).then(function(){c&&c.call(),e.addGrape(a,g,h)})}))},Filemanager.fn.removeFile=function(a,b){var c=this;dblocalfiles.files.query("name").only(a).execute().then(function(d){if(d.length>0){var e=d[0].id;dblocalfiles.files.remove(e).then(function(d){c.removeGrape(a),b&&b.call()})}})},Filemanager.fn.removeGrape=function(a){filemanageropen&&by("id:file_list").getChildren().each(function(){this._calmly_nom_doc+this._calmly_id_doc+".cml"==a&&this.stop().animate(200).opacity(0).done(function(){this.remove()})})},Filemanager.fn.addGrape=function(a,b,c){if(filemanageropen){var d=!1;if(by("id:file_list").getChildren().each(function(){this._calmly_nom_doc+this._calmly_id_doc+".cml"==a&&(d=!0)}),0==d){var e=this.generateGrape(a,b,c);e.opacity(0).hide(),by("id:file_list").addChild(e),e.toBack(),e.show().animate(200).opacity(1)}}},Filemanager.fn.readFile=function(a,b){var c=this;dblocalfiles.files.query("name").only(a).execute().then(function(a){a.length>0&&b&&b.call(c,a[0].content)})},Filemanager.fn.searchByFullPath=function(a,b,c){var d=this;this.getFiles(function(e){for(var f=0;f<e.length;f++)if(e[f].fullpath&&e[f].fullpath==a&&e[f].name&&e[f].name.substr(0,e[f].name.length-40)==b)return void(c&&c.call(d,e[f]));c&&c.call(d,null)})},Filemanager.fn.renameFile=function(a,b,c){if(a==b)return!1;dblocalfiles.files.query("name").only(a).modify({name:b,date:(new Date).getTime(),changed:!0,fullpath:""}).execute().then(function(){filemanager.fs.root.getFile(a,{},function(a){a.moveTo(filemanager.fs.root,b,function(){c&&c.call()},d)},d)});var d=function(a){console.log(a),c&&c.call()}};
